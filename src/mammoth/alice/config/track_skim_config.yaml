---
# NOTE: Convention for map keys and anchors - if they lead with an `_`, they are meant to be private,
#       which is to say, not to be used directly in a production.  Nothing is critical here - it's
#       just to make it easier to keep track of everything.
# NOTE: All files are assumed to be in the base_output_dir, which is by default the `trains` directory.
skimmed_datasets:
  # pp
  # LHC17pq pass 1
  LHC17pq_pass1_AOD234_2111_2112: &LHC17pq_pp
    name: "LHC17pq_pass1_AOD234_2111_2112"
    collision_system: "pp"
    sqrt_s: 5020
    period: "LHC17pq"
    # Keep track of the skim type for documentation
    skim_type: "track_skim"
    # Parameters of the output
    list_name: "AliAnalysisTaskTrackSkim_pp"
    tree_name: "AliAnalysisTaskTrackSkim_pp_tree"
    levels_in_output_file:
      - "data"
    files:
      # LHC17p
      - "pp/2111/run_by_run/LHC17p_CENT_woSDD/*/AnalysisResults.17p.*.root"
      - "pp/2111/run_by_run/LHC17p_FAST/*/AnalysisResults.17p.*.root"
      # LHC17q
      - "pp/2112/run_by_run/LHC17q_CENT_woSDD/*/AnalysisResults.17q.*.root"
      - "pp/2112/run_by_run/LHC17q_FAST/*/AnalysisResults.17q.*.root"
  # LHC17pq pass 2
  LHC17pq_pass2_AOD_2351_2352: &LHC17pq_pp_pass2
    name: "LHC17pq_pass2_AOD_2351_2352"
    collision_system: "pp"
    sqrt_s: 5020
    period: "LHC17pq"
    # Keep track of the skim type for documentation
    skim_type: "track_skim"
    # Parameters of the output
    list_name: "AliAnalysisTaskTrackSkim_pp"
    tree_name: "AliAnalysisTaskTrackSkim_pp_tree_v3"
    levels_in_output_file:
      - "data"
    files:
      # LHC17p
      - "pp/2351/run_by_run/LHC17p_CENT_woSDD/*/AnalysisResults.17p.*.root"
      - "pp/2351/run_by_run/LHC17p_FAST/*/AnalysisResults.17p.*.root"
      # LHC17q
      - "pp/2352/run_by_run/LHC17q_CENT_woSDD/*/AnalysisResults.17q.*.root"
      - "pp/2352/run_by_run/LHC17q_FAST/*/AnalysisResults.17q.*.root"

  # pp_MC
  # pythia
  # Anchored to LHC17pq pass1
  LHC18b8_AOD_2619: &LHC18b8_pythia
    name: "LHC18b8_AOD_2619"
    collision_system: "pythia"
    generator:
      name: "pythia"
      identifier: "pythia"
      parameters: {}
    sqrt_s: 5020
    period: "LHC18b8"
    anchor_period: ["LHC17p", "LHC17q"]
    # Keep track of the skim type for documentation
    skim_type: "track_skim"
    # Parameters of the output
    list_name: "AliAnalysisTaskTrackSkim_pythia"
    tree_name: "AliAnalysisTaskTrackSkim_pythia_tree"
    levels_in_output_file:
      - "data"
      - "gen"
    n_pt_hat_bins: 20
    files:
      - "pythia/2619/run_by_run/LHC18b8_cent_woSDD/*/{pt_hat_bin}/AnalysisResults.18b8_cent_woSDD.*.root"
      - "pythia/2619/run_by_run/LHC18b8_fast/*/{pt_hat_bin}/AnalysisResults.18b8_fast.*.root"
  # Anchored to LHC17pq pass2
  LHC23a3_AOD_2907: &LHC23a3_pythia
    name: "LHC23a3_AOD_2907"
    collision_system: "pp_MC"
    generator:
      name: "pythia"
      parameters: {}
    sqrt_s: 5020
    period: "LHC23a3"
    anchor_period: ["LHC17p", "LHC17q"]
    # Keep track of the skim type for documentation
    skim_type: "track_skim"
    # Parameters of the output
    list_name: "AliAnalysisTaskTrackSkim_pythia"
    tree_name: "AliAnalysisTaskTrackSkim_pythia_tree_v3"
    levels_in_output_file:
      - "data"
      - "gen"
    n_pt_hat_bins: 20
    files:
      - "pythia/2907/run_by_run/LHC23a3_cent_woSDD/*/{pt_hat_bin}/AnalysisResults.23a3_cent_woSDD.*.root"
      - "pythia/2907/run_by_run/LHC23a3_fast/*/{pt_hat_bin}/AnalysisResults.23a3_fast.*.root"

  # Anchored to LHC18qr pass3
  LHC20g4_AOD_2640: &LHC20g4_pythia
    name: "LHC20g4_AOD_2640"
    collision_system: "pythia"
    generator:
      name: "pythia"
      parameters: {}
    sqrt_s: 5020
    period: "LHC20g4"
    anchor_period: ["LHC18q", "LHC18r"]
    # Keep track of the skim type for documentation
    skim_type: "track_skim"
    # Parameters of the output
    list_name: "AliAnalysisTaskTrackSkim_pythia"
    tree_name: "AliAnalysisTaskTrackSkim_pythia_tree"
    levels_in_output_file:
      - "data"
      - "gen"
    n_pt_hat_bins: 20
    files:
      - "pythia/2640/run_by_run/LHC20g4/*/{pt_hat_bin}/AnalysisResults.20g4.*.root"
  # LBL Fast Sims
  # This is a FastSim of the LHC18b8 Pythia production anchored to 17pq
  LBL20_Pythia_FastSim_1_258314: &LBL20_Pythia_FastSim_1_17pq
    name: "LBL20_Pythia_FastSim_1_258314"
    collision_system: "pp_MC"
    generator:
      name: "pythia"
      identifier: "pythia_fastsim"
      parameters:
        fastsim: true
    sqrt_s: 5020
    period: "LBL20_Pythia_FastSim_1"
    anchor_period: ["LHC17p", "LHC17q"]
    # Keep track of the skim type for documentation
    skim_type: "HF_tree_at_LBL"
    skim_parameters:
      levels: ["part_level", "det_level"]
      column_modifications:
        part_level:
          "ParticlePID": ""
        det_level:
          "ParticlePID": ""
    # NOTE: The scale factors need to be copied to the appropriate production directory
    # Binning is the standard binning for LHC18b8
    n_pt_hat_bins: 20
    number_of_parent_directories_to_pt_hat_bin: 3
    # Number of parent directories to go up to create the relative output filename
    # NOTE: Only needed if the inputs are not in the trains directory, as is the cause on hiccup
    # NOTE: We go up to 5 since the run numbers overlap between FAST and CENT_woSDD, so they will
    #       overwrite each other unless we known which child train output they are from.
    number_of_parent_directories_for_relative_output_filename: 5
    files:
      - "pp_MC/258314/files.txt"
  # Anchored is unclear, but I suspect that it's LHC17pq (?)
  LBL20_Herwig_FastSim_1_266374: &LBL20_Herwig_FastSim_1_17pq
    name: "LBL20_Herwig_FastSim_1_266374"
    collision_system: "pp_MC"
    # Generator config at: `pyjetty/pyjetty/alice_analysis/generation/herwig/herwig_slurm.sh`
    generator:
      name: "herwig"
      identifier: "herwig_fastsim"
      parameters:
        fastsim: true
    sqrt_s: 5020
    period: "LBL20_Herwig_FastSim_1"
    anchor_period: ["LHC17p", "LHC17q"]
    # Keep track of the skim type for documentation
    skim_type: "HF_tree_at_LBL"
    skim_parameters:
      levels: ["part_level", "det_level"]
      column_modifications:
        part_level:
          "ParticlePID": ""
        det_level:
          "ParticlePID": ""
    # NOTE: The scale factors need to be copied to the appropriate production directory
    # Binning: (5 7 9 12 16 21 28 36 45 57 70 85 99 115 132 150 169 190 212 235 260)
    n_pt_hat_bins: 20
    number_of_parent_directories_to_pt_hat_bin: 2
    # Number of parent directories to go up to create the relative output filename
    # NOTE: Only needed if the inputs are not in the trains directory, as is the cause on hiccup
    number_of_parent_directories_for_relative_output_filename: 3
    files:
      - "pythia/266374/files.txt"
  # JETSCAPE PP19
  # Arbitrarily defined as #1 in JETSCAPE productions
  JETSCAPE_PP19_1: &JETSCAPE_PP19
    name: "JETSCAPE_PP19_1"
    collision_system: "pp_MC"
    generator:
      name: "jetscape"
      parameters: {}
    sqrt_s: 5020
    period: ""
    # Keep track of the skim type for documentation
    skim_type: "jetscape"
    skim_parameters:
      levels: ["part_level"]
      legacy_skim: true
    # Parameters of the output
    n_pt_hat_bins: 66
    files:
      - "pp_MC/jetscape/0001/JetscapeHadronListBin*.parquet"
  # JEWEL pp
  # Particle level only
  LBL21_JEWEL_823890: &LBL21_JEWEL_pp_1
    name: "LBL21_JEWEL_823890"
    collision_system: "pp_MC"
    generator:
      name: "jewel"
      parameters: {}
    sqrt_s: 5020
    period: "LBL21_JEWEL_pp_1"
    # Keep track of the skim type for documentation
    skim_type: "HF_tree_at_LBL"
    skim_parameters:
      levels: ["part_level"]
      column_modifications: {}
    # NOTE: The scale factors need to be copied to the appropriate production directory
    # Binning: (5 7 9 12 16 21 28 36 45 57 70 85 99 115 132 150 169 190 212 235 260)
    n_pt_hat_bins: 20
    number_of_parent_directories_to_pt_hat_bin: 2
    # Number of parent directories to go up to create the relative output filename
    # NOTE: Only needed if the inputs are not in the trains directory, as is the cause on hiccup
    number_of_parent_directories_for_relative_output_filename: 3
    files:
      - "pp_MC/823890/files.txt"

  # PbPb
  LHC18qr_pass3_AOD252_central_642: &LHC18qr_PbPb_central
    name: "LHC18qr_pass3_AOD252_central_642"
    collision_system: "PbPb"
    sqrt_s: 5020
    period: ["LHC18q", "LHC18r"]
    # Keep track of the skim type for documentation
    skim_type: "track_skim"
    # Parameters of the output
    list_name: "AliAnalysisTaskTrackSkim_PbPb_central"
    tree_name: "AliAnalysisTaskTrackSkim_PbPb_central_tree"
    levels_in_output_file:
      - "data"
    files:
      - "PbPb/642/run_by_run/LHC18q/*/AnalysisResults.18q.*.root"
      - "PbPb/642/run_by_run/LHC18r/*/AnalysisResults.18r.*.root"
  LHC18qr_pass3_AOD252_semi_central_645: &LHC18qr_PbPb_semi_central
    name: "LHC18qr_pass3_AOD252_semi_central_645"
    collision_system: "PbPb"
    sqrt_s: 5020
    period: ["LHC18q", "LHC18r"]
    # Keep track of the skim type for documentation
    skim_type: "track_skim"
    # Parameters of the output
    list_name: "AliAnalysisTaskTrackSkim_PbPb_semi_central"
    tree_name: "AliAnalysisTaskTrackSkim_PbPb_semi_central_tree"
    levels_in_output_file:
      - "data"
    files:
      - "PbPb/645/run_by_run/LHC18q/*/AnalysisResults.18q.*.root"
      - "PbPb/645/run_by_run/LHC18r/*/AnalysisResults.18r.*.root"
  LHC15o_pass1_AOD194_central_7666: &LHC15o_PbPb_central
    name: "LHC15o_pass1_AOD194_central_7666"
    collision_system: "PbPb"
    sqrt_s: 5020
    period: "LHC15o"
    # Keep track of the skim type for documentation
    skim_type: "track_skim"
    # Parameters of the output
    list_name: "AliAnalysisTaskTrackSkim_PbPb_central"
    tree_name: "AliAnalysisTaskTrackSkim_PbPb_central_tree"
    levels_in_output_file:
      - "data"
    files:
      - "PbPb/7666/run_by_run/LHC15o/*/AnalysisResults.15o.*.root"
  LHC15o_pass1_AOD194_semi_central_7668: &LHC15o_PbPb_semi_central
    name: "LHC15o_pass1_AOD194_semi_central_7668"
    collision_system: "PbPb"
    sqrt_s: 5020
    period: "LHC15o"
    # Keep track of the skim type for documentation
    skim_type: "track_skim"
    # Parameters of the output
    list_name: "AliAnalysisTaskTrackSkim_PbPb_semi_central"
    tree_name: "AliAnalysisTaskTrackSkim_PbPb_semi_central_tree"
    levels_in_output_file:
      - "data"
    files:
      - "PbPb/7668/run_by_run/LHC15o/*/AnalysisResults.15o.*.root"
  # PbPb @ LBL
  # LHC18qr
  # NOTE: I'm reasonably certain that it's pass3, but I'm not 100% sure
  LHC18qr_pass3_AOD252_central_570_LBL: &LHC18qr_PbPb_central_at_LBL
    name: "LHC18qr_pass3_AOD252_central_570_LBL"
    collision_system: "PbPb"
    sqrt_s: 5020
    period: ["LHC18q", "LHC18r"]
    # Keep track of the skim type for documentation
    skim_type: "HF_tree_at_LBL"
    skim_parameters:
      levels: ["data"]
      column_modifications:
        # ParticlePID isn't available in data.
        data:
          "ParticlePID": ""
    # Number of parent directories to go up to create the relative output filename
    # NOTE: We go up to 5 since we want to get to a period label. It's slightly redundant,
    #       but I'm concerned that leading with a train number will look quite odd to my eyes.
    #       Better to have a slightly longer filename that will avoid confusion.
    number_of_parent_directories_for_relative_output_filename: 5
    files:
      - "PbPb/570/files.txt"

  # PbPb_MC
  ##########
  # Standard
  ##########
  LBL21_JEWEL_NoRecoils_Central_1_746611: &LBL21_JEWEL_NoRecoils_Central_1
    name: "LBL21_JEWEL_NoRecoils_Central_1_746611"
    collision_system: "PbPb_MC"
    generator:
      name: "jewel"
      identifier: "jewel__central__wo_recoils"
      parameters:
        recoils: false
        fastsim: false
    sqrt_s: 5020
    period: "LBL21_JEWEL_NoRecoils_1"
    # Keep track of the skim type for documentation
    skim_type: "HF_tree_at_LBL"
    skim_parameters:
      levels: ["part_level"]
      column_modifications:
        # NOTE: The "Status" is removed since it's only available with recoils
        part_level:
          "Status": ""
    # NOTE: The scale factors need to be copied to the appropriate production directory
    # Binning: (5 7 9 12 16 21 28 36 45 57 70 85 99 115 132 150 169 190 212 235 260)
    n_pt_hat_bins: 20
    number_of_parent_directories_to_pt_hat_bin: 2
    # Number of parent directories to go up to create the relative output filename
    # NOTE: Only needed if the inputs are not in the trains directory, as is the cause on hiccup
    number_of_parent_directories_for_relative_output_filename: 3
    files:
      - "PbPb_MC/746611/files.txt"
  LBL21_JEWEL_Recoils_Central_1_851894: &LBL21_JEWEL_Recoils_Central_1
    name: "LBL21_JEWEL_Recoils_Central_1_851894"
    collision_system: "PbPb_MC"
    generator:
      name: "jewel"
      identifier: "jewel__central__w_recoils"
      parameters:
        fastsim: false
        recoils: true
    sqrt_s: 5020
    period: "LBL21_JEWEL_Recoils_1"
    # Keep track of the skim type for documentation
    skim_type: "HF_tree_at_LBL"
    skim_parameters:
      levels: ["part_level"]
      column_modifications:
        part_level:
          "Status": "identifier"
    # NOTE: The scale factors need to be copied to the appropriate production directory
    # Binning: (5 7 9 12 16 21 28 36 45 57 70 85 99 115 132 150 169 190 212 235 260)
    n_pt_hat_bins: 20
    number_of_parent_directories_to_pt_hat_bin: 2
    # Number of parent directories to go up to create the relative output filename
    # NOTE: Only needed if the inputs are not in the trains directory, as is the cause on hiccup
    number_of_parent_directories_for_relative_output_filename: 3
    files:
      - "PbPb_MC/851894/files.txt"
  #########
  # FastSim
  #########
  LBL21_JEWEL_NoRecoils_Central_FastSim_1_798301: &LBL21_JEWEL_NoRecoils_Central_FastSim_1
    name: "LBL21_JEWEL_NoRecoils_Central_FastSim_1_798301"
    collision_system: "PbPb_MC"
    generator:
      name: "jewel"
      identifier: "jewel__central__wo_recoils_fastsim"
      parameters:
        recoils: false
        fastsim: true
    sqrt_s: 5020
    period: "LBL21_JEWEL_NoRecoils_FastSim_1"
    # Keep track of the skim type for documentation
    skim_type: "HF_tree_at_LBL"
    skim_parameters:
      levels: ["part_level", "det_level"]
      column_modifications:
        # NOTE: The "Status" is removed since it's only available with recoils.
        #       (Strictly speaking, we don't need to remove it here, since it's
        #       not included by default, but since this is new, it's good to have
        #       some explicit examples.)
        part_level:
          "Status": ""
          "ParticlePID": ""
        det_level:
          "Status": ""
          "ParticlePID": ""
    # NOTE: The scale factors need to be copied to the appropriate production directory
    # Binning: (5 7 9 12 16 21 28 36 45 57 70 85 99 115 132 150 169 190 212 235 260)
    n_pt_hat_bins: 20
    number_of_parent_directories_to_pt_hat_bin: 2
    # Number of parent directories to go up to create the relative output filename
    # NOTE: Only needed if the inputs are not in the trains directory, as is the cause on hiccup
    number_of_parent_directories_for_relative_output_filename: 3
    files:
      - "PbPb_MC/798301/files.txt"
      # - "PbPb_MC/798301/files_test.txt"
  LBL21_JEWEL_Recoils_Central_FastSim_1_996432: &LBL21_JEWEL_Recoils_Central_FastSim_1
    name: "LBL21_JEWEL_Recoils_Central_FastSim_1_996432"
    collision_system: "PbPb_MC"
    generator:
      name: "jewel"
      identifier: "jewel__central__w_recoils_fastsim"
      parameters:
        fastsim: true
        recoils: true
    sqrt_s: 5020
    period: "LBL21_JEWEL_Recoils_FastSim_1"
    # Keep track of the skim type for documentation
    skim_type: "HF_tree_at_LBL"
    skim_parameters:
      levels: ["part_level", "det_level"]
      column_modifications:
        # NOTE: "ParticlePID" tends not be available for fastsim outputs
        part_level:
          "Status": "identifier"
          "ParticlePID": ""
        det_level:
          "Status": "identifier"
          "ParticlePID": ""
    # NOTE: The scale factors need to be copied to the appropriate production directory
    # Binning: (5 7 9 12 16 21 28 36 45 57 70 85 99 115 132 150 169 190 212 235 260)
    n_pt_hat_bins: 20
    number_of_parent_directories_to_pt_hat_bin: 2
    # Number of parent directories to go up to create the relative output filename
    # NOTE: Only needed if the inputs are not in the trains directory, as is the cause on hiccup
    number_of_parent_directories_for_relative_output_filename: 3
    files:
      - "PbPb_MC/996432/files.txt"

generator_arguments:
  _default_pp_MC: &generator_arguments_default_pp_MC
    select_charged_particles: true

  _default_pp_MC_fastsim: &generator_arguments_default_pp_MC_fastsim
    # NOTE: We cannot make any selections here since we don't usually have the PID information.
    #       We rely on the production to have made the right selections.
    #       Due to the code conventions, we have to explicitly turn it off here to remind ourselves.
    select_charged_particles: false

  _default_pp_ALICE_production: &generator_arguments_default_pp_MC_alice_production
    # NOTE: Detector level for ALICE productions does not include PID information.
    #       Consequently, we rely on the production to make the right selections.
    #       Due to the code conventions, we have to explicitly turn it off here to remind ourselves.
    select_charged_particles: false

  _default_PbPb_MC: &generator_arguments_default_PbPb_MC
    select_charged_particles: true

  _default_JEWEL_PbPb_MC: &generator_arguments_default_JEWEL_PbPb_MC
    select_charged_particles: true
    # Default is (e-, mu-, pi+, K+, p+, Sigma+, Sigma-, Xi-, Omega-), but then we need to
    # add [2, 21] (u, g) for holes. We also add [d, s, c, b, u] = [1, 3, 4, 5, 6] since the
    # specification isn't specific, to my knowledge. It shouldn't hurt anything to have the rest
    # of the quarks
    custom_charged_hadron_PIDs: [1, 2, 3, 4, 5, 6, 21, 11, 13, 211, 321, 2212, 3222, 3112, 3312, 3334]
  _default_JEWEL_PbPb_MC_fastsim: &generator_arguments_default_JEWEL_PbPb_MC_fastsim
    # NOTE: We cannot make any selections here since we don't usually have the PID information.
    #       We rely on the production to have made the right selections.
    #       Due to the code conventions, we have to explicitly turn it off here to remind ourselves.
    selected_charged_particles: false
    eta_range: 1.0

dataset_metadata_settings:
  _base:
    _pp: &base_metadata_pp
      # Parameters relevant for loading the dataset
      # Map from value -> key of how prefixes should be renamed when loading data
      loading_data_rename_levels:
        data: "data"

    _pp_MC_one_level: &base_metadata_pp_MC_one_level
      # Parameters relevant for loading the dataset
      # Map from value -> key of how prefixes should be renamed when loading data
      loading_data_rename_levels:
        data: "part_level"
    _pythia: &base_metadata_pythia
      # Parameters relevant for loading the dataset
      # Map from value -> key of how prefixes should be renamed when loading data
      # For pythia, this isn't necessary since it has a dedicated function for loading MC data
      loading_data_rename_levels: {}

    _PbPb: &base_metadata_PbPb
      # Parameters relevant for loading the dataset
      # Map from value -> key of how prefixes should be renamed when loading data
      loading_data_rename_levels:
        data: "data"

    _embed: &base_metadata_embed
      # Parameters relevant for loading the dataset
      # Map from value -> key of how prefixes should be renamed when loading data
      # For embedding, this isn't necessary since it has a dedicated function for loading embedding data
      loading_data_rename_levels: {}
      # This functionality maps the standard embedding level names to custom ones. e.g. use this to
      # analyze the hybrid as standard data.
      post_embedding_rename_levels: {}
      input_constrained_source: "signal"
      input_handling:
        signal_parameters:
          # NOTE: Now these are extracted from the actual dataset configs. Comment is left here
          #       for reference.
          # collision_system: "pythia"
          constrained_source: # ie. signal is the constraint
            n_files_to_use_per_task: 1
          unconstrained_source:
            # Sample pt hat bin distribution equally
            # NOTE: This option isn't meaningful in the constrained source case
            sample_each_pt_hat_bin_equally: true
            # Number of signal files to make available to a background file
            # This ensures some additional diversity if we end up with a very small signal file
            n_files_to_use_per_task: 3
        background_parameters:
          # NOTE: Now these are extracted from the actual dataset configs. Comment is left here
          #       for reference.
          # collision_system: "PbPb"
          constrained_source: # ie. background is the constraint
            n_files_to_use_per_task: 1
          unconstrained_source:
            n_files_to_use_per_task: 2

    _embed_thermal_model: &base_metadata_embed_thermal_model
      # Parameters relevant for loading the dataset
      # Map from value -> key of how prefixes should be renamed when loading data
      # For embedding, this isn't necessary since it has a dedicated function for loading embedding data
      loading_data_rename_levels: {}

    _PbPb_MC: &base_metadata_PbPb_MC
      # Parameters relevant for loading the dataset
      # Map from value -> key of how prefixes should be renamed when loading data
      loading_data_rename_levels:
        data: "part_level"
    _PbPb_MC_two_level: &base_metadata_PbPb_MC_two_level
      # Parameters relevant for loading the dataset
      # Map from value -> key of how prefixes should be renamed when loading data
      # NOTE: This isn't necessary here!
      loading_data_rename_levels: {}

analysis_settings:
  # This is the base - ie. the default - settings for reclustered substructure
  _reclustered_substructure_settings:
    output_settings: &reclustered_substructure_output_settings
      primary_output:
        type: "skim"
        reference_name: "tree"
        container_name: ""
      return_skim: false
      write_chunk_skim: true
      write_skim_extension: "root"
      explode_skim_fields_to_separate_directories: false
      return_merged_hists: false
      write_chunk_hists: false
      write_merged_hists: true

    _pp: &_reclustered_substructure_settings_pp
      track_skim_to_flat_skim_level_names: # Map from track_skim level -> level of the structured jet substructure format
        data: "data"
      analysis_input_levels: ["data"]
      splittings_selection: "iterative"
      # In GeV
      min_jet_pt: { "data": 5 }

    _pp_MC: &_reclustered_substructure_settings_pp_MC
      track_skim_to_flat_skim_level_names: # Map from track_skim level -> level of the structured jet substructure format
        det_level: "data"
        part_level: "true"
      analysis_input_levels: ["det_level", "part_level"]
      splittings_selection: "iterative"
      # In GeV
      # We don't want to restrict the part_level
      min_jet_pt: { "det_level": 5 }
      # By default, don't apply any additional reduction
      det_level_artificial_tracking_efficiency: 1.0

    _PbPb: &_reclustered_substructure_settings_PbPb
      track_skim_to_flat_skim_level_names: # Map from track_skim level -> level of the structured jet substructure format
        data: "data"
      analysis_input_levels: ["data"]
      splittings_selection: "iterative"
      # In GeV
      min_jet_pt: { "data": 20 }

    _PbPb_MC: &_reclustered_substructure_settings_PbPb_MC
      track_skim_to_flat_skim_level_names: # Map from track_skim level -> level of the structured jet substructure format
        det_level: "data"
        part_level: "true"
      analysis_input_levels: ["det_level", "part_level"]
      splittings_selection: "iterative"
      # In GeV
      # We don't want to restrict the part_level
      # NOTE: We dropped the det_level to a smaller value than the PbPb data because we want
      #       to be able to see the trends over a larger range. It should still be a manageable output size.
      min_jet_pt: { "det_level": 10 }
      # By default, don't apply any additional reduction
      det_level_artificial_tracking_efficiency: 1.0

    _embed: &_reclustered_substructure_settings_embed
      track_skim_to_flat_skim_level_names: # Map from track_skim level -> level of the structured jet substructure format
        hybrid_level: "hybrid"
        det_level: "det_level"
        part_level: "true"
      analysis_input_levels: ["hybrid_level", "det_level", "part_level"]
      splittings_selection: "iterative"
      # In GeV
      # We don't want to restrict the "det_level" or "part_level" jet pt values
      min_jet_pt: { "hybrid_level": 20 }

  _hardest_kt_settings:
    _standard_parameters:
      selected_grooming_methods: &hardest_kt_selected_grooming_methods
        - "dynamical_core"
        - "dynamical_kt"
        - "dynamical_time"
        - "dynamical_core_z_cut_02"
        - "dynamical_kt_z_cut_02"
        - "dynamical_time_z_cut_02"
        - "soft_drop_z_cut_02"
        - "soft_drop_z_cut_04"
    pp_R02: &analysis_settings_hardest_kt_pp_R02
      <<: *_reclustered_substructure_settings_pp
      jet_R: 0.2
      selected_grooming_methods: *hardest_kt_selected_grooming_methods
    pp_R04: &analysis_settings_hardest_kt_pp_R04
      <<: *_reclustered_substructure_settings_pp
      jet_R: 0.4
      selected_grooming_methods: *hardest_kt_selected_grooming_methods

    pp_MC_R02: &analysis_settings_hardest_kt_pp_MC_R02
      <<: *_reclustered_substructure_settings_pp_MC
      jet_R: 0.2
      selected_grooming_methods: *hardest_kt_selected_grooming_methods
    pp_MC_R04: &analysis_settings_hardest_kt_pp_MC_R04
      <<: *_reclustered_substructure_settings_pp_MC
      jet_R: 0.4
      selected_grooming_methods: *hardest_kt_selected_grooming_methods

    PbPb_R02: &analysis_settings_hardest_kt_PbPb_R02
      <<: *_reclustered_substructure_settings_PbPb
      jet_R: 0.2
      selected_grooming_methods: *hardest_kt_selected_grooming_methods

    PbPb_MC_R02: &analysis_settings_hardest_kt_PbPb_MC_R02
      <<: *_reclustered_substructure_settings_PbPb_MC
      jet_R: 0.2
      selected_grooming_methods: *hardest_kt_selected_grooming_methods

    embed_R02: &analysis_settings_hardest_kt_embed_R02
      <<: *_reclustered_substructure_settings_embed
      jet_R: 0.2
      selected_grooming_methods: *hardest_kt_selected_grooming_methods

    embed_R02_fastsim: &analysis_settings_hardest_kt_embed_R02_fastsim
      <<: *_reclustered_substructure_settings_embed
      jet_R: 0.2
      selected_grooming_methods: *hardest_kt_selected_grooming_methods
      # In the case of a fastsim, we usually don't have identifiers between part_level and det_level.
      # Consequently, we can't rely on the identifier for matching. Instead, we have to use distance matching.
      # NOTE: The det_level and hybrid usually still work, since it's basically just matching the
      #       det_level identifier that we generate back to itself. If this becomes an issue later,
      #       we'll have to add another setting.
      # NOTE: To be 100% clear, this is due to the signal dataset, not the background dataset!
      match_det_level_true_using_distance: true

  _time_reclustering_settings:
    reclustering_settings: &_time_reclustering_reclustering_settings
      algorithm: "generalized_kt"
      additional_algorithm_parameter: 0.5

    pp_R04: &analysis_settings_time_reclustering_pp_R04
      <<: *_reclustered_substructure_settings_pp
      jet_R: 0.4
      reclustering_settings:
        <<: *_time_reclustering_reclustering_settings

    pp_MC_R04: &analysis_settings_time_reclustering_pp_MC_R04
      <<: *_reclustered_substructure_settings_pp_MC
      jet_R: 0.4
      reclustering_settings:
        <<: *_time_reclustering_reclustering_settings

    PbPb_R04: &analysis_settings_time_reclustering_PbPb_R04
      <<: *_reclustered_substructure_settings_PbPb
      jet_R: 0.4
      reclustering_settings:
        <<: *_time_reclustering_reclustering_settings

    embed_R04: &analysis_settings_time_reclustering_embed_R04
      <<: *_reclustered_substructure_settings_embed
      jet_R: 0.4
      reclustering_settings:
        <<: *_time_reclustering_reclustering_settings

  ########################3
  # Energy-energy correlators
  ########################3
  _EEC_analysis_settings:
    # Base settings for E1C and EEC -- applied to all analyses of the particular class
    one_particle_correlator_settings: &_base_analysis_settings_E1C
      momentum_weight_exponent: 1
      # In the way that we've implemented it as of April 2024, this is the maximum delta
      # phi from the trigger recoil axis
      max_delta_phi_from_axis: 1.570796326794897 # pi/2

    two_particle_correlator_settings: &_base_analysis_settings_EEC
      momentum_weight_exponent: 1
      max_delta_phi_from_axis: 1.570796326794897 # pi/2

    # We don't want to automatically apply these settings, but only take use selectively
    default_parameters:
      trigger_parameters_hadron: &analysis_settings_EEC_trigger_hadron
        classes:
          reference: [5., 7.]
          signal: [20., 50.]
        parameters:
          type: "hadron"
          kinematic_label: "pt"
      trigger_parameters_jet: &analysis_settings_EEC_trigger_jet
        classes:
          signal: [20., 120.]
        parameters:
          type: "jet"
          kinematic_label: "pt"
          jet_R: 0.4
      trigger_parameters_photon: &analysis_settings_EEC_trigger_photon
        classes:
          reference: [5., 7.]
          signal: [20, 50]
        parameters:
          type: "photon"
          kinematic_label: "E"
          isolation_cone: 0.4
          max_background_in_isolation: 2. # in GeV
      default_output_settings:
        one_input_level: &EEC_output_settings_hadron_trigger_one_input_level
          primary_output:
            type: "hists"
            reference_name: "data_level_reference_eec"
            container_name: ""
          return_skim: false
          write_chunk_skim: false
          write_skim_extension: "parquet"
          return_merged_hists: false
          write_chunk_hists: false
          write_merged_hists: true
        two_input_level: &EEC_output_settings_hadron_trigger_two_input_level
          primary_output:
            type: "hists"
            reference_name: "det_level_reference_eec"
            container_name: ""
          return_skim: false
          write_chunk_skim: false
          write_skim_extension: "parquet"
          return_merged_hists: false
          write_chunk_hists: false
          write_merged_hists: true

    pp: &analysis_settings_EEC_pp
      <<: *_base_analysis_settings_E1C
      analysis_input_levels: ["data"]
      trigger_parameters:
        <<: *analysis_settings_EEC_trigger_hadron
      correlator_type: "one_particle"
      # In GeV
      min_track_pt:
        data: 0.15

    pp_MC: &analysis_settings_EEC_pp_MC
      <<: *_base_analysis_settings_E1C
      analysis_input_levels: ["det_level", "part_level"]
      trigger_parameters:
        <<: *analysis_settings_EEC_trigger_hadron
      correlator_type: "one_particle"
      # In GeV
      min_track_pt:
        part_level: 0.15
        det_level: 0.15
      # By default, don't apply any additional reduction
      det_level_artificial_tracking_efficiency: 1.0

    PbPb: &analysis_settings_EEC_PbPb
      <<: *_base_analysis_settings_E1C
      analysis_input_levels: ["data"]
      trigger_parameters:
        <<: *analysis_settings_EEC_trigger_hadron
      correlator_type: "one_particle"
      # In GeV
      min_track_pt:
        data: 0.15

    embed: &analysis_settings_EEC_embed
      <<: *_base_analysis_settings_E1C
      analysis_input_levels: ["hybrid_level", "det_level", "part_level"]
      trigger_parameters:
        <<: *analysis_settings_EEC_trigger_hadron
      correlator_type: "one_particle"
      # In GeV
      min_track_pt:
        part_level: 0.15
        det_level: 0.15
        hybrid_level: 0.15

  # NOTE: We don't need an explicit one for embedding into a thermal model - we can
  #       just take the standard embedding analysis settings

productions:
  pp:
    2:
      metadata:
        <<: *base_metadata_pp
        dataset: *LHC17pq_pp
        production_number: 2
        label: ""
      settings:
        <<: *analysis_settings_hardest_kt_pp_R02
    3:
      metadata:
        <<: *base_metadata_pp
        dataset: *LHC17pq_pp_pass2
        production_number: 3
        label: ""
      settings:
        <<: *analysis_settings_time_reclustering_pp_R04
        output_settings:
          <<: *reclustered_substructure_output_settings
        selected_grooming_methods:
          - "soft_drop_z_cut_02"
    60:
      # R = 0.2 pp production
      metadata:
        <<: *base_metadata_pp
        dataset: *LHC17pq_pp
        production_number: 60
        label: ""
      settings:
        <<: *analysis_settings_hardest_kt_pp_R02
    61:
      # R = 0.4 pp production
      metadata:
        <<: *base_metadata_pp
        dataset: *LHC17pq_pp
        production_number: 61
        label: ""
      settings:
        <<: *analysis_settings_hardest_kt_pp_R04
    62:
      # R = 0.2 pp pass 2 production
      metadata:
        <<: *base_metadata_pp
        dataset: *LHC17pq_pp_pass2
        production_number: 62
        label: ""
      settings:
        <<: *analysis_settings_hardest_kt_pp_R02
        output_settings:
          <<: *reclustered_substructure_output_settings

  pythia:
    # Debug
    3:
      metadata:
        <<: *base_metadata_pythia
        dataset: *LHC18b8_pythia
        production_number: 3
        label: ""
      settings:
        <<: *analysis_settings_hardest_kt_pp_MC_R02
    4:
      metadata:
        <<: *base_metadata_pythia
        dataset: *LBL20_Herwig_FastSim_1_17pq
        production_number: 4
        label: "herwig"
      settings:
        <<: *analysis_settings_hardest_kt_pp_MC_R02
    # Production
    60:
      metadata:
        <<: *base_metadata_pythia
        dataset: *LHC18b8_pythia
        production_number: 60
        label: ""
      settings:
        <<: *analysis_settings_hardest_kt_pp_MC_R02
    61:
      # Tracking efficiency systematic
      metadata:
        <<: *base_metadata_pythia
        dataset: *LHC18b8_pythia
        production_number: 61
        label: ""
      settings:
        <<: *analysis_settings_hardest_kt_pp_MC_R02
        apply_pt_dependent_tracking_efficiency_uncertainty: true
    62:
      # Tracking efficiency systematic (for consistency with the preliminaries)
      metadata:
        <<: *base_metadata_pythia
        dataset: *LHC18b8_pythia
        production_number: 62
        label: ""
      settings:
        <<: *analysis_settings_hardest_kt_pp_MC_R02
        det_level_artificial_tracking_efficiency: 0.96
        apply_pt_dependent_tracking_efficiency_uncertainty: false
    63:
      metadata:
        <<: *base_metadata_pythia
        dataset: *LBL20_Herwig_FastSim_1_17pq
        production_number: 63
        label: "herwig_fastsim"
      settings:
        <<: *analysis_settings_hardest_kt_pp_MC_R02
    64:
      metadata:
        <<: *base_metadata_pythia
        dataset: *LBL20_Pythia_FastSim_1_17pq
        production_number: 64
        label: "pythia_fastsim"
      settings:
        <<: *analysis_settings_hardest_kt_pp_MC_R02
    65:
      # R = 0.4 production
      metadata:
        <<: *base_metadata_pythia
        dataset: *LHC18b8_pythia
        production_number: 65
        label: ""
      settings:
        <<: *analysis_settings_hardest_kt_pp_MC_R04
    66:
      # R = 0.4 production, tracking efficiency systematic
      metadata:
        <<: *base_metadata_pythia
        dataset: *LHC18b8_pythia
        production_number: 66
        label: ""
      settings:
        <<: *analysis_settings_hardest_kt_pp_MC_R04
        apply_pt_dependent_tracking_efficiency_uncertainty: true
    67:
      # R = 0.4 HERWIG fastsim
      metadata:
        <<: *base_metadata_pythia
        dataset: *LBL20_Herwig_FastSim_1_17pq
        production_number: 67
        label: "herwig_fastsim"
      settings:
        <<: *analysis_settings_hardest_kt_pp_MC_R04
    68:
      # R = 0.4 PYTHIA fastsim
      metadata:
        <<: *base_metadata_pythia
        dataset: *LBL20_Pythia_FastSim_1_17pq
        production_number: 68
        label: "pythia_fastsim"
      settings:
        <<: *analysis_settings_hardest_kt_pp_MC_R04
    ##################################################
    # NOTE: Don't add more here - do it below in pp_MC
    ##################################################

  pp_MC:
    3:
      metadata:
        dataset: *JETSCAPE_PP19
        production_number: 3
        label: ""
      settings:
        <<: *analysis_settings_hardest_kt_pp_MC_R02
    # Time reclustering pythia test
    # NOTE: This is the wrong dataset for pythia, but its useful for testing
    4:
      metadata:
        <<: *base_metadata_pythia
        dataset: *LHC20g4_pythia
        production_number: 4
        label: ""
      settings:
        <<: *analysis_settings_time_reclustering_pp_MC_R04
        output_settings:
          <<: *reclustered_substructure_output_settings
        selected_grooming_methods:
          - "soft_drop_z_cut_02"
    # Time reclustering pythia fastsim
    5:
      metadata:
        <<: *base_metadata_pythia
        dataset: *LBL20_Pythia_FastSim_1_17pq
        production_number: 5
        label: "pythia_fastsim"
      settings:
        <<: *analysis_settings_time_reclustering_pp_MC_R04
        selected_grooming_methods:
          - "soft_drop_z_cut_02"
    # Time reclustering pythia fastsim - hiccup stability test
    6:
      metadata:
        <<: *base_metadata_pythia
        dataset: *LBL20_Pythia_FastSim_1_17pq
        production_number: 6
        label: "pythia_fastsim"
      settings:
        <<: *analysis_settings_time_reclustering_pp_MC_R04
        # Setting this to null uses the default CA reclustering settings
        reclustering_settings: null
        chunk_size: 5000
        output_settings:
          <<: *reclustered_substructure_output_settings
        selected_grooming_methods:
          - "soft_drop_z_cut_02"
    # EEC: Debugging with a fraction of stats on my MBP
    7:
      metadata:
        dataset: *LHC20g4_pythia
        #sample_dataset_fraction: 0.1
        # Equivalent to train number, but a more general term makes more sense here.
        production_number: 7
        label: ""
      settings:
        <<: *analysis_settings_EEC_pp_MC
        chunk_size: 5000
        combinatorics_chunk_size: 500
        output_settings:
          <<: *EEC_output_settings_hadron_trigger_two_input_level
    # NOTE: Starts at 69 to be consistent with the "pythia", which this generalizes from.
    # Pythia fastsim w/ time reclustering
    69:
      metadata:
        <<: *base_metadata_pythia
        dataset: *LBL20_Pythia_FastSim_1_17pq
        production_number: 69
        label: "pythia_fastsim"
      settings:
        <<: *analysis_settings_time_reclustering_pp_MC_R04
        output_settings:
          <<: *reclustered_substructure_output_settings
        selected_grooming_methods:
          - "soft_drop_z_cut_02"
    # Herwig fastsim w/ time reclustering
    70:
      metadata:
        <<: *base_metadata_pythia
        dataset: *LBL20_Herwig_FastSim_1_17pq
        production_number: 70
        label: "herwig_fastsim"
      settings:
        <<: *analysis_settings_time_reclustering_pp_MC_R04
        output_settings:
          <<: *reclustered_substructure_output_settings
        selected_grooming_methods:
          - "soft_drop_z_cut_02"
    # Pythia fastsim w/ CA reclustering
    71:
      metadata:
        <<: *base_metadata_pythia
        dataset: *LBL20_Pythia_FastSim_1_17pq
        production_number: 71
        label: "pythia_fastsim"
      settings:
        <<: *analysis_settings_time_reclustering_pp_MC_R04
        reclustering_settings: null
        output_settings:
          <<: *reclustered_substructure_output_settings
        selected_grooming_methods:
          - "soft_drop_z_cut_02"
    # Herwig fastsim w/ CA reclustering
    72:
      metadata:
        <<: *base_metadata_pythia
        dataset: *LBL20_Herwig_FastSim_1_17pq
        production_number: 72
        label: "herwig_fastsim"
      settings:
        <<: *analysis_settings_time_reclustering_pp_MC_R04
        reclustering_settings: null
        output_settings:
          <<: *reclustered_substructure_output_settings
        selected_grooming_methods:
          - "soft_drop_z_cut_02"
    # Hardest kt, R = 0.2 pass 2 anchored production
    73:
      metadata:
        <<: *base_metadata_pythia
        dataset: *LHC23a3_pythia
        production_number: 73
        label: ""
      settings:
        <<: *analysis_settings_hardest_kt_pp_MC_R02
        output_settings:
          <<: *reclustered_substructure_output_settings
    # Hardest kt, R = 0.2 pass 2 anchored tracking efficiency systematic
    74:
      metadata:
        <<: *base_metadata_pythia
        dataset: *LHC23a3_pythia
        production_number: 74
        label: ""
      settings:
        <<: *analysis_settings_hardest_kt_pp_MC_R02
        apply_pt_dependent_tracking_efficiency_uncertainty: true
        output_settings:
          <<: *reclustered_substructure_output_settings
    # EEC: Single particle, two input levels.
    # NOTE: Using pass1, since I don't 100% trust pass2 at the moment (April 2024)
    75:
      metadata:
        dataset: *LHC18b8_pythia
        # Equivalent to train number, but a more general term makes more sense here.
        production_number: 75
        label: ""
      settings:
        <<: *analysis_settings_EEC_pp_MC
        chunk_size: 5000
        combinatorics_chunk_size: 1000
        output_settings:
          <<: *EEC_output_settings_hadron_trigger_two_input_level
    # EEC: Single particle, two input levels.
    #      - multiple bug fixes compared to 75.
    76:
      metadata:
        dataset: *LHC18b8_pythia
        # Equivalent to train number, but a more general term makes more sense here.
        production_number: 76
        label: ""
      settings:
        <<: *analysis_settings_EEC_pp_MC
        chunk_size: 5000
        combinatorics_chunk_size: 1000
        output_settings:
          <<: *EEC_output_settings_hadron_trigger_two_input_level
    77:
      # JEWEL pp hardest kt
      metadata:
        <<: *base_metadata_pp_MC_one_level
        dataset: *LBL21_JEWEL_pp_1
        production_number: 77
        label: ""
      settings:
        <<: *analysis_settings_hardest_kt_pp_R02
        output_settings:
          <<: *reclustered_substructure_output_settings
        # And disable artificial tracking efficiency
        det_level_artificial_tracking_efficiency: 1.0
        generator_analysis_arguments:
          <<: *generator_arguments_default_pp_MC
          name: "jewel"

  PbPb:
    2:
      metadata:
        <<: *base_metadata_PbPb
        dataset: *LHC18qr_PbPb_semi_central
        # Equivalent to train number, but a more general term makes more sense here.
        production_number: 2
        label: "semi_central"
      settings:
        <<: *analysis_settings_hardest_kt_PbPb_R02
        event_activity: "semi_central"
        background_subtraction:
          r_max: 0.5
    3:
      metadata:
        <<: *base_metadata_PbPb
        dataset: *LHC18qr_PbPb_semi_central
        # Equivalent to train number, but a more general term makes more sense here.
        production_number: 3
        label: "semi_central"
      settings:
        <<: *analysis_settings_hardest_kt_PbPb_R02
        event_activity: "semi_central"
        background_subtraction:
          r_max: 0.05
    # Time reclustering PbPb
    4:
      metadata:
        <<: *base_metadata_PbPb
        dataset: *LHC18qr_PbPb_semi_central
        # Equivalent to train number, but a more general term makes more sense here.
        production_number: 4
        label: "semi_central"
      settings:
        <<: *analysis_settings_time_reclustering_PbPb_R04
        selected_grooming_methods:
          - "soft_drop_z_cut_02"
        event_activity: "semi_central"
        background_subtraction:
          r_max: 0.25
    60:
      metadata:
        <<: *base_metadata_PbPb
        dataset: *LHC18qr_PbPb_central
        # Equivalent to train number, but a more general term makes more sense here.
        production_number: 60
        label: "central"
      settings:
        <<: *analysis_settings_hardest_kt_PbPb_R02
        event_activity: "central"
    61:
      metadata:
        <<: *base_metadata_PbPb
        dataset: *LHC18qr_PbPb_semi_central
        # Equivalent to train number, but a more general term makes more sense here.
        production_number: 61
        label: "semi_central"
      settings:
        <<: *analysis_settings_hardest_kt_PbPb_R02
        event_activity: "semi_central"
        background_subtraction:
          r_max: 0.5
    62:
      metadata:
        <<: *base_metadata_PbPb
        dataset: *LHC18qr_PbPb_semi_central
        # Equivalent to train number, but a more general term makes more sense here.
        production_number: 62
        label: "semi_central"
      settings:
        <<: *analysis_settings_hardest_kt_PbPb_R02
        event_activity: "semi_central"
        background_subtraction:
          r_max: 0.05
    63:
      metadata:
        <<: *base_metadata_PbPb
        dataset: *LHC18qr_PbPb_semi_central
        # Equivalent to train number, but a more general term makes more sense here.
        production_number: 63
        label: "semi_central"
      settings:
        <<: *analysis_settings_hardest_kt_PbPb_R02
        event_activity: "semi_central"
        background_subtraction:
          r_max: 0.7
    # *****************************
    # Start of validated track skim
    # *****************************
    64:
      # Nominal, r_max = 0.1
      metadata:
        <<: *base_metadata_PbPb
        dataset: *LHC18qr_PbPb_semi_central
        # Equivalent to train number, but a more general term makes more sense here.
        production_number: 64
        label: "semi_central"
      settings:
        <<: *analysis_settings_hardest_kt_PbPb_R02
        event_activity: "semi_central"
        background_subtraction:
          r_max: 0.1
    65:
      # Background systematic, r_max = 0.05
      metadata:
        <<: *base_metadata_PbPb
        dataset: *LHC18qr_PbPb_semi_central
        # Equivalent to train number, but a more general term makes more sense here.
        production_number: 65
        label: "semi_central"
      settings:
        <<: *analysis_settings_hardest_kt_PbPb_R02
        event_activity: "semi_central"
        background_subtraction:
          r_max: 0.05
    66:
      # Background systematic, r_max = 0.50
      metadata:
        <<: *base_metadata_PbPb
        dataset: *LHC18qr_PbPb_semi_central
        # Equivalent to train number, but a more general term makes more sense here.
        production_number: 66
        label: "semi_central"
      settings:
        <<: *analysis_settings_hardest_kt_PbPb_R02
        event_activity: "semi_central"
        background_subtraction:
          r_max: 0.50
    # **********************************************
    # Added new grooming methods, adding z_cut to DyG
    # ***********************************************
    67:
      # Nominal, r_max = 0.1. Added 31 Jan 2023
      metadata:
        <<: *base_metadata_PbPb
        dataset: *LHC18qr_PbPb_semi_central
        # Equivalent to train number, but a more general term makes more sense here.
        production_number: 67
        label: "semi_central"
      settings:
        <<: *analysis_settings_hardest_kt_PbPb_R02
        event_activity: "semi_central"
        background_subtraction:
          r_max: 0.1
    68:
      # Background systematic, r_max = 0.05. Added 31 Jan 2023
      metadata:
        <<: *base_metadata_PbPb
        dataset: *LHC18qr_PbPb_semi_central
        production_number: 68
        label: "semi_central"
      settings:
        <<: *analysis_settings_hardest_kt_PbPb_R02
        event_activity: "semi_central"
        background_subtraction:
          r_max: 0.05
    69:
      # Background systematic, r_max = 0.50. Added 31 Jan 2023
      metadata:
        <<: *base_metadata_PbPb
        dataset: *LHC18qr_PbPb_semi_central
        production_number: 69
        label: "semi_central"
      settings:
        <<: *analysis_settings_hardest_kt_PbPb_R02
        event_activity: "semi_central"
        background_subtraction:
          r_max: 0.50
    70:
      # Nominal, central, r_max = 0.1. Added 4 Feb 2023
      metadata:
        <<: *base_metadata_PbPb
        dataset: *LHC18qr_PbPb_central
        production_number: 70
        label: "central"
      settings:
        <<: *analysis_settings_hardest_kt_PbPb_R02
        event_activity: "central"
        background_subtraction:
          r_max: 0.1
    71:
      # Background systematic, r_max = 0.05. Added 6 Feb 2023
      metadata:
        <<: *base_metadata_PbPb
        dataset: *LHC18qr_PbPb_central
        production_number: 71
        label: "central"
      settings:
        <<: *analysis_settings_hardest_kt_PbPb_R02
        event_activity: "central"
        background_subtraction:
          r_max: 0.05
    72:
      # Background systematic, r_max = 0.50. Added 6 Feb 2023
      metadata:
        <<: *base_metadata_PbPb
        dataset: *LHC18qr_PbPb_central
        production_number: 72
        label: "central"
      settings:
        <<: *analysis_settings_hardest_kt_PbPb_R02
        event_activity: "central"
        background_subtraction:
          r_max: 0.50
    73:
      # Nominal, central, r_max = 0.1, 10% fraction of data to check how many jets
      # are removed by the jet cuts. Added 8 Jan 2025
      metadata:
        <<: *base_metadata_PbPb
        dataset: *LHC18qr_PbPb_central
        sample_dataset_fraction: 0.1
        production_number: 73
        label: "central"
      settings:
        <<: *analysis_settings_hardest_kt_PbPb_R02
        output_settings:
          <<: *reclustered_substructure_output_settings
        event_activity: "central"
        background_subtraction:
          r_max: 0.1

  PbPb_MC:
    # Testing with JEWEL no recoils
    3:
      metadata:
        <<: *base_metadata_PbPb_MC
        dataset: *LBL21_JEWEL_Recoils_Central_1
        production_number: 3
        label: "central"
      settings:
        <<: *analysis_settings_hardest_kt_PbPb_R02
        output_settings:
          <<: *reclustered_substructure_output_settings
        event_activity: "central"
        # And disable artificial tracking efficiency
        det_level_artificial_tracking_efficiency: 1.0
        generator_analysis_arguments:
          <<: *generator_arguments_default_JEWEL_PbPb_MC
          background_treatment: "constituent_subtraction"
          #background_treatment: null
    60:
      # JEWEL w/ recoils particle-level, hardest kt
      metadata:
        <<: *base_metadata_PbPb_MC
        dataset: *LBL21_JEWEL_Recoils_Central_1
        production_number: 60
        label: "central"
      settings:
        <<: *analysis_settings_hardest_kt_PbPb_R02
        output_settings:
          <<: *reclustered_substructure_output_settings
        event_activity: "central"
        # And disable artificial tracking efficiency
        det_level_artificial_tracking_efficiency: 1.0
        generator_analysis_arguments:
          <<: *generator_arguments_default_JEWEL_PbPb_MC
          background_treatment: "constituent_subtraction"
    61:
      # JEWEL w/out recoils particle-level, hardest kt
      metadata:
        <<: *base_metadata_PbPb_MC
        dataset: *LBL21_JEWEL_NoRecoils_Central_1
        production_number: 61
        label: "central"
      settings:
        <<: *analysis_settings_hardest_kt_PbPb_R02
        output_settings:
          <<: *reclustered_substructure_output_settings
        event_activity: "central"
        # And disable artificial tracking efficiency
        det_level_artificial_tracking_efficiency: 1.0
        generator_analysis_arguments:
          <<: *generator_arguments_default_JEWEL_PbPb_MC
          background_treatment: null
    62:
      # JEWEL w/ recoils fastsim, hardest kt
      metadata:
        <<: *base_metadata_PbPb_MC_two_level
        dataset: *LBL21_JEWEL_Recoils_Central_FastSim_1
        production_number: 62
        label: "central"
      settings:
        <<: *analysis_settings_hardest_kt_PbPb_MC_R02
        output_settings:
          <<: *reclustered_substructure_output_settings
        event_activity: "central"
        # And disable artificial tracking efficiency
        det_level_artificial_tracking_efficiency: 1.0
        generator_analysis_arguments:
          <<: *generator_arguments_default_JEWEL_PbPb_MC_fastsim
          background_treatment: "constituent_subtraction"
    63:
      # JEWEL w/out recoils fastsim, hardest kt
      metadata:
        <<: *base_metadata_PbPb_MC_two_level
        dataset: *LBL21_JEWEL_NoRecoils_Central_FastSim_1
        production_number: 63
        label: "central"
      settings:
        <<: *analysis_settings_hardest_kt_PbPb_MC_R02
        output_settings:
          <<: *reclustered_substructure_output_settings
        event_activity: "central"
        # And disable artificial tracking efficiency
        det_level_artificial_tracking_efficiency: 1.0
        generator_analysis_arguments:
          <<: *generator_arguments_default_JEWEL_PbPb_MC_fastsim
          background_treatment: null

  embed_pythia:
    2:
      metadata:
        <<: *base_metadata_embed
        dataset: *LHC18qr_PbPb_semi_central
        signal_dataset: *LHC20g4_pythia
        # Equivalent to train number, but a more general term makes more sense here.
        production_number: 2
        label: "embed_pythia_semi_central"
      settings:
        <<: *analysis_settings_hardest_kt_embed_R02
        event_activity: "semi_central"
        background_subtraction:
          r_max: 0.05
        # Artificial tracking efficiency derived from the full jet R_AA paper.
        # 10-30 \approx .99
        # 0-10% \approx .98
        # Apply only to embedded particles
        det_level_artificial_tracking_efficiency: 0.99
    3:
      metadata:
        <<: *base_metadata_embed
        dataset: *LHC18qr_PbPb_semi_central
        signal_dataset: *LHC20g4_pythia
        # Equivalent to train number, but a more general term makes more sense here.
        production_number: 3
        label: "embed_pythia_semi_central"
      settings:
        <<: *analysis_settings_hardest_kt_embed_R02
        event_activity: "semi_central"
        background_subtraction:
          r_max: 0.1
        det_level_artificial_tracking_efficiency: 0.99
    4:
      metadata:
        <<: *base_metadata_embed
        dataset: *LHC18qr_PbPb_semi_central
        signal_dataset: *LHC20g4_pythia
        # Equivalent to train number, but a more general term makes more sense here.
        production_number: 4
        label: "embed_pythia_semi_central"
      settings:
        <<: *analysis_settings_hardest_kt_embed_R02
        event_activity: "semi_central"
        #chunk_size: 15000
        chunk_size: 5000
        background_subtraction:
          r_max: 0.1
        det_level_artificial_tracking_efficiency: 0.99
    60:
      metadata:
        <<: *base_metadata_embed
        dataset: *LHC18qr_PbPb_semi_central
        signal_dataset: *LHC20g4_pythia
        # Equivalent to train number, but a more general term makes more sense here.
        production_number: 60
        label: "embed_pythia_semi_central"
      settings:
        <<: *analysis_settings_hardest_kt_embed_R02
        event_activity: "semi_central"
        background_subtraction:
          r_max: 0.05
        det_level_artificial_tracking_efficiency: 0.99
    61:
      # Additional statistics for production 60
      metadata:
        <<: *base_metadata_embed
        dataset: *LHC18qr_PbPb_semi_central
        signal_dataset: *LHC20g4_pythia
        # Equivalent to train number, but a more general term makes more sense here.
        production_number: 61
        label: "embed_pythia_semi_central"
      settings:
        <<: *analysis_settings_hardest_kt_embed_R02
        event_activity: "semi_central"
        background_subtraction:
          r_max: 0.05
        det_level_artificial_tracking_efficiency: 0.99
    62:
      metadata:
        <<: *base_metadata_embed
        dataset: *LHC18qr_PbPb_semi_central
        signal_dataset: *LHC20g4_pythia
        # Equivalent to train number, but a more general term makes more sense here.
        production_number: 62
        label: "embed_pythia_semi_central"
      settings:
        <<: *analysis_settings_hardest_kt_embed_R02
        event_activity: "semi_central"
        background_subtraction:
          r_max: 0.7
        det_level_artificial_tracking_efficiency: 0.99
    63:
      # Additional statistics for production 62
      metadata:
        <<: *base_metadata_embed
        dataset: *LHC18qr_PbPb_semi_central
        signal_dataset: *LHC20g4_pythia
        # Equivalent to train number, but a more general term makes more sense here.
        production_number: 63
        label: "embed_pythia_semi_central"
      settings:
        <<: *analysis_settings_hardest_kt_embed_R02
        event_activity: "semi_central"
        background_subtraction:
          r_max: 0.7
        det_level_artificial_tracking_efficiency: 0.99
    # *****************************
    # Start of validated track skim
    # *****************************
    # NOTE: For now, we use background as the constraint, but we'll try to keep working on moving to the
    #       signal as the constraint
    64:
      # Nominal, r_max = 0.1
      metadata:
        <<: *base_metadata_embed
        dataset: *LHC18qr_PbPb_semi_central
        signal_dataset: *LHC20g4_pythia
        # Equivalent to train number, but a more general term makes more sense here.
        production_number: 64
        label: "embed_pythia_semi_central"
      settings:
        <<: *analysis_settings_hardest_kt_embed_R02
        event_activity: "semi_central"
        background_subtraction:
          r_max: 0.1
        det_level_artificial_tracking_efficiency: 0.99
        apply_pt_dependent_tracking_efficiency_uncertainty: false
    65:
      # Background systematic, r_max = 0.05
      metadata:
        <<: *base_metadata_embed
        dataset: *LHC18qr_PbPb_semi_central
        signal_dataset: *LHC20g4_pythia
        # Equivalent to train number, but a more general term makes more sense here.
        production_number: 65
        label: "embed_pythia_semi_central"
      settings:
        <<: *analysis_settings_hardest_kt_embed_R02
        event_activity: "semi_central"
        background_subtraction:
          r_max: 0.05
        det_level_artificial_tracking_efficiency: 0.99
        apply_pt_dependent_tracking_efficiency_uncertainty: false
    66:
      # Background systematic, r_max = 0.50
      metadata:
        <<: *base_metadata_embed
        dataset: *LHC18qr_PbPb_semi_central
        signal_dataset: *LHC20g4_pythia
        # Equivalent to train number, but a more general term makes more sense here.
        production_number: 66
        label: "embed_pythia_semi_central"
      settings:
        <<: *analysis_settings_hardest_kt_embed_R02
        event_activity: "semi_central"
        background_subtraction:
          r_max: 0.50
        det_level_artificial_tracking_efficiency: 0.99
        apply_pt_dependent_tracking_efficiency_uncertainty: false
    # **********************************************
    # Added new grooming methods, adding z_cut to DyG
    # ***********************************************
    # Attempt to switch to signal as the constraint from here!
    67:
      # Nominal, r_max = 0.1. Added 31 Jan 23023
      metadata:
        <<: *base_metadata_embed
        dataset: *LHC18qr_PbPb_semi_central
        signal_dataset: *LHC20g4_pythia
        production_number: 67
        label: "embed_pythia_semi_central"
      settings:
        <<: *analysis_settings_hardest_kt_embed_R02
        event_activity: "semi_central"
        chunk_size: 4000
        background_subtraction:
          r_max: 0.1
        det_level_artificial_tracking_efficiency: 0.99
        apply_pt_dependent_tracking_efficiency_uncertainty: false
    68:
      # Background systematic, r_max = 0.05. Added 31 Jan 2023
      metadata:
        <<: *base_metadata_embed
        dataset: *LHC18qr_PbPb_semi_central
        signal_dataset: *LHC20g4_pythia
        production_number: 68
        label: "embed_pythia_semi_central"
      settings:
        <<: *analysis_settings_hardest_kt_embed_R02
        event_activity: "semi_central"
        chunk_size: 4000
        background_subtraction:
          r_max: 0.05
        det_level_artificial_tracking_efficiency: 0.99
        apply_pt_dependent_tracking_efficiency_uncertainty: false
    69:
      # Background systematic, r_max = 0.50. Added 31 Jan 2023
      metadata:
        <<: *base_metadata_embed
        dataset: *LHC18qr_PbPb_semi_central
        signal_dataset: *LHC20g4_pythia
        production_number: 69
        label: "embed_pythia_semi_central"
      settings:
        <<: *analysis_settings_hardest_kt_embed_R02
        event_activity: "semi_central"
        chunk_size: 4000
        background_subtraction:
          r_max: 0.50
        det_level_artificial_tracking_efficiency: 0.99
        apply_pt_dependent_tracking_efficiency_uncertainty: false
    70:
      # Tracking efficiency systematic, r_max = 0.1. Added 5 Feb 2023
      metadata:
        <<: *base_metadata_embed
        dataset: *LHC18qr_PbPb_semi_central
        signal_dataset: *LHC20g4_pythia
        production_number: 70
        label: "embed_pythia_semi_central"
      settings:
        <<: *analysis_settings_hardest_kt_embed_R02
        event_activity: "semi_central"
        chunk_size: 4000
        background_subtraction:
          r_max: 0.1
        det_level_artificial_tracking_efficiency: 0.95
        apply_pt_dependent_tracking_efficiency_uncertainty: false
    #########
    # Central
    #########
    71:
      # Central nominal, r_max = 0.1. Added 6 Feb 2023
      metadata:
        <<: *base_metadata_embed
        dataset: *LHC18qr_PbPb_central
        signal_dataset: *LHC20g4_pythia
        production_number: 71
        label: "embed_pythia_central"
      settings:
        <<: *analysis_settings_hardest_kt_embed_R02
        event_activity: "central"
        chunk_size: 4000
        background_subtraction:
          r_max: 0.1
        det_level_artificial_tracking_efficiency: 0.98
        apply_pt_dependent_tracking_efficiency_uncertainty: false
    72:
      # Background systematic, r_max = 0.05. Added 6 Feb 2023
      metadata:
        <<: *base_metadata_embed
        dataset: *LHC18qr_PbPb_central
        signal_dataset: *LHC20g4_pythia
        production_number: 72
        label: "embed_pythia_central"
      settings:
        <<: *analysis_settings_hardest_kt_embed_R02
        event_activity: "central"
        chunk_size: 4000
        background_subtraction:
          r_max: 0.05
        det_level_artificial_tracking_efficiency: 0.98
        apply_pt_dependent_tracking_efficiency_uncertainty: false
    73:
      # Background systematic, r_max = 0.50
      metadata:
        <<: *base_metadata_embed
        dataset: *LHC18qr_PbPb_central
        signal_dataset: *LHC20g4_pythia
        production_number: 73
        label: "embed_pythia_central"
      settings:
        <<: *analysis_settings_hardest_kt_embed_R02
        event_activity: "central"
        chunk_size: 4000
        background_subtraction:
          r_max: 0.50
        det_level_artificial_tracking_efficiency: 0.98
        apply_pt_dependent_tracking_efficiency_uncertainty: false
    74:
      # Tracking efficiency systematic, r_max = 0.1. Added 5 Feb 2023
      metadata:
        <<: *base_metadata_embed
        dataset: *LHC18qr_PbPb_central
        signal_dataset: *LHC20g4_pythia
        production_number: 74
        label: "embed_pythia_central"
      settings:
        <<: *analysis_settings_hardest_kt_embed_R02
        event_activity: "central"
        chunk_size: 4000
        background_subtraction:
          r_max: 0.1
        det_level_artificial_tracking_efficiency: 0.98
        apply_pt_dependent_tracking_efficiency_uncertainty: true
    75:
      # Tracking efficiency systematic with pt dependence for semi-central, r_max = 0.1. Added 14 Feb 2023
      metadata:
        <<: *base_metadata_embed
        dataset: *LHC18qr_PbPb_semi_central
        signal_dataset: *LHC20g4_pythia
        production_number: 75
        label: "embed_pythia_semi_central"
      settings:
        <<: *analysis_settings_hardest_kt_embed_R02
        event_activity: "semi_central"
        chunk_size: 4000
        background_subtraction:
          r_max: 0.1
        det_level_artificial_tracking_efficiency: 0.99
        apply_pt_dependent_tracking_efficiency_uncertainty: true
    76:
      # Tracking efficiency systematic without pt dependence, r_max = 0.1. Added 14 Feb 2023
      # Since the central was not approved previously, there's no need to use the standard 4% - I can
      # just jump right to the pt dependent approach.
      metadata:
        <<: *base_metadata_embed
        dataset: *LHC18qr_PbPb_central
        signal_dataset: *LHC20g4_pythia
        production_number: 76
        label: "embed_pythia_central"
      settings:
        <<: *analysis_settings_hardest_kt_embed_R02
        event_activity: "central"
        chunk_size: 4000
        background_subtraction:
          r_max: 0.1
        det_level_artificial_tracking_efficiency: 0.94
        apply_pt_dependent_tracking_efficiency_uncertainty: false
    # There was a bug in passing the pt dependent tracking efficiency uncertainty to the task settings
    # in productions 74 and 75 (it was in the steering). Therefore, we create new productions here.
    # They're identical configurations but I want new production numbers for bookkeeping.
    # (NOTE: I also put the semi-central first now...)
    77:
      # Tracking efficiency systematic with pt dependence for semi-central, r_max = 0.1. Added 1 April 2024
      # This includes a bug fix for passing the pt dependent tracking efficiency
      metadata:
        <<: *base_metadata_embed
        dataset: *LHC18qr_PbPb_semi_central
        signal_dataset: *LHC20g4_pythia
        production_number: 77
        label: "embed_pythia_semi_central"
      settings:
        <<: *analysis_settings_hardest_kt_embed_R02
        output_settings:
          <<: *reclustered_substructure_output_settings
        event_activity: "semi_central"
        chunk_size: 4000
        background_subtraction:
          r_max: 0.1
        det_level_artificial_tracking_efficiency: 0.99
        apply_pt_dependent_tracking_efficiency_uncertainty: true
    78:
      # Tracking efficiency systematic with pt dependence for central, r_max = 0.1. Added 1 April 2024.
      # This includes a bug fix for passing the pt dependent tracking efficiency
      metadata:
        <<: *base_metadata_embed
        dataset: *LHC18qr_PbPb_central_at_LBL
        signal_dataset: *LHC20g4_pythia
        production_number: 78
        label: "embed_pythia_central"
      settings:
        <<: *analysis_settings_hardest_kt_embed_R02
        output_settings:
          <<: *reclustered_substructure_output_settings
        event_activity: "central"
        chunk_size: 4000
        background_subtraction:
          r_max: 0.1
        det_level_artificial_tracking_efficiency: 0.98
        apply_pt_dependent_tracking_efficiency_uncertainty: true
    # For kt model dependence, we need central nominal, r_max = 0.1 for
    # - pythia_fastsim embedded
    # - jewel no recoils embedded
    # - jewel recoils embedded (ideally, but probably not worth the effort...)
    79:
      # pythia fastsim embedded into central, r_max = 0.1.
      metadata:
        <<: *base_metadata_embed
        dataset: *LHC18qr_PbPb_central_at_LBL
        signal_dataset: *LBL20_Pythia_FastSim_1_17pq
        production_number: 79
        label: "embed_pythia_fastsim_central"
      settings:
        <<: *analysis_settings_hardest_kt_embed_R02_fastsim
        output_settings:
          <<: *reclustered_substructure_output_settings
        event_activity: "central"
        chunk_size: 4000
        background_subtraction:
          r_max: 0.1
        det_level_artificial_tracking_efficiency: 0.98
        apply_pt_dependent_tracking_efficiency_uncertainty: false
        generator_analysis_arguments:
          <<: *generator_arguments_default_pp_MC_fastsim
          name: "pythia"
    80:
      # JEWEL no recoils fastsim embedded into central, r_max = 0.1.
      metadata:
        <<: *base_metadata_embed
        dataset: *LHC18qr_PbPb_central_at_LBL
        signal_dataset: *LBL21_JEWEL_NoRecoils_Central_FastSim_1
        production_number: 80
        label: "embed_jewel_NoRecoils_fastsim_central"
      settings:
        <<: *analysis_settings_hardest_kt_embed_R02_fastsim
        output_settings:
          <<: *reclustered_substructure_output_settings
        event_activity: "central"
        chunk_size: 4000
        background_subtraction:
          r_max: 0.1
        det_level_artificial_tracking_efficiency: 0.98
        apply_pt_dependent_tracking_efficiency_uncertainty: false
        generator_analysis_arguments:
          <<: *generator_arguments_default_JEWEL_PbPb_MC_fastsim
          background_treatment: null
    # There was a bug in passing the background subtraction r_max to the task settings
    # in productions 77 and 78 (it was a mismatch in the naming). Therefore, we create new productions here.
    # They're identical configurations but I want new production numbers for bookkeeping.
    81:
      # Tracking efficiency systematic with pt dependence for semi-central, r_max = 0.1. Added 17 June 2024.
      # This includes a bug fix for passing the background subtraction r_max
      metadata:
        <<: *base_metadata_embed
        dataset: *LHC18qr_PbPb_semi_central
        signal_dataset: *LHC20g4_pythia
        production_number: 81
        label: "embed_pythia_semi_central"
      settings:
        <<: *analysis_settings_hardest_kt_embed_R02
        output_settings:
          <<: *reclustered_substructure_output_settings
        event_activity: "semi_central"
        chunk_size: 4000
        background_subtraction:
          r_max: 0.1
        det_level_artificial_tracking_efficiency: 0.99
        apply_pt_dependent_tracking_efficiency_uncertainty: true
        generator_analysis_arguments:
          <<: *generator_arguments_default_pp_MC_alice_production
    82:
      # Tracking efficiency systematic with pt dependence for central, r_max = 0.1. Added 17 June 2024.
      # This includes a bug fix for passing the background subtraction r_max
      metadata:
        <<: *base_metadata_embed
        dataset: *LHC18qr_PbPb_central_at_LBL
        signal_dataset: *LHC20g4_pythia
        production_number: 82
        label: "embed_pythia_central"
      settings:
        <<: *analysis_settings_hardest_kt_embed_R02
        output_settings:
          <<: *reclustered_substructure_output_settings
        event_activity: "central"
        chunk_size: 4000
        background_subtraction:
          r_max: 0.1
        det_level_artificial_tracking_efficiency: 0.98
        apply_pt_dependent_tracking_efficiency_uncertainty: true
        generator_analysis_arguments:
          <<: *generator_arguments_default_pp_MC_alice_production

  embed_thermal_model:
    2:
      metadata:
        <<: *base_metadata_embed_thermal_model
        dataset: *LHC20g4_pythia
        # Equivalent to train number, but a more general term makes more sense here.
        production_number: 2
        label: "embed_pythia_semi_central"
      settings:
        <<: *analysis_settings_hardest_kt_embed_R02
        event_activity: "semi_central"
        chunk_size: 5000
        background_subtraction:
          r_max: 0.25
        # Artificial tracking efficiency derived from the full jet R_AA paper.
        # 10-30 \approx .99
        # 0-10% \approx .98
        # Apply only to embedded particles
        det_level_artificial_tracking_efficiency: 0.99

    3:
      # Debug EECs
      metadata:
        dataset: *LHC20g4_pythia
        # Equivalent to train number, but a more general term makes more sense here.
        production_number: 3
        label: "embed_pythia_semi_central"
      settings:
        <<: *analysis_settings_EEC_embed
        event_activity: "central"
        chunk_size: 1000
        output_trigger_skim: true
        # Artificial tracking efficiency to convert tracking in PYTHIA to similar performance as PbPb
        # Applied only to embedded particles
        det_level_artificial_tracking_efficiency: 0.98
    4:
      # EECs with a fraction of stats on my MBP
      metadata:
        dataset: *LHC20g4_pythia
        sample_dataset_fraction: 0.1
        # Equivalent to train number, but a more general term makes more sense here.
        production_number: 4
        label: "embed_pythia_semi_central"
      settings:
        <<: *analysis_settings_EEC_embed
        event_activity: "central"
        chunk_size: 1000
        output_trigger_skim: true
        # Artificial tracking efficiency to convert tracking in PYTHIA to similar performance as PbPb
        # Applied only to embedded particles
        det_level_artificial_tracking_efficiency: 0.98
    5:
      # Test using the new, full refactored steering code
      metadata:
        dataset: *LHC20g4_pythia
        sample_dataset_fraction: 0.1
        # Equivalent to train number, but a more general term makes more sense here.
        production_number: 5
        label: "embed_pythia_semi_central"
      settings:
        <<: *analysis_settings_EEC_embed
        event_activity: "central"
        chunk_size: 1000
        combinatorics_chunk_size: 250
        # Artificial tracking efficiency to convert tracking in PYTHIA to similar performance as PbPb
        # Applied only to embedded particles
        det_level_artificial_tracking_efficiency: 0.98
        output_settings:
          primary_output:
            type: "hists"
            reference_name: "hybrid_level_reference_eec"
            container_name: ""
          return_skim: false
          write_chunk_skim: false
          write_skim_extension: "parquet"
          return_merged_hists: false
          write_chunk_hists: false
          write_merged_hists: true
    6:
      # Nominal - test for comparison to 63...
      metadata:
        <<: *base_metadata_embed_thermal_model
        dataset: *LHC20g4_pythia
        production_number: 6
        label: "embed_pythia_central"
      settings:
        <<: *analysis_settings_hardest_kt_embed_R02
        output_settings:
          <<: *reclustered_substructure_output_settings
        event_activity: "central"
        chunk_size: 4000
        background_subtraction:
          r_max: 0.1
        det_level_artificial_tracking_efficiency: 0.98
        generator_analysis_arguments:
          # We don't need to select charged particles since it's an ALICE production.
          # All good
          select_charged_particles: false

    60:
      metadata:
        <<: *base_metadata_embed_thermal_model
        dataset: *LHC20g4_pythia
        # Equivalent to train number, but a more general term makes more sense here.
        production_number: 60
        label: "embed_pythia_semi_central"
      settings:
        <<: *analysis_settings_hardest_kt_embed_R02
        event_activity: "semi_central"
        chunk_size: 5000
        background_subtraction:
          r_max: 0.25
        # Artificial tracking efficiency derived from the full jet R_AA paper.
        # 10-30 \approx .99
        # 0-10% \approx .98
        # Apply only to embedded particles
        det_level_artificial_tracking_efficiency: 0.99
    # **********************************************
    # Added new grooming methods, adding z_cut to DyG
    # ***********************************************
    61:
      # Nominal. Added 31 Jan 2023
      metadata:
        <<: *base_metadata_embed_thermal_model
        dataset: *LHC20g4_pythia
        production_number: 61
        label: "embed_pythia_semi_central"
      settings:
        <<: *analysis_settings_hardest_kt_embed_R02
        event_activity: "semi_central"
        chunk_size: 4000
        background_subtraction:
          r_max: 0.1
        det_level_artificial_tracking_efficiency: 0.99
    62:
      # Nominal. Added 6 Feb 2023
      metadata:
        <<: *base_metadata_embed_thermal_model
        dataset: *LHC20g4_pythia
        production_number: 62
        label: "embed_pythia_central"
      settings:
        <<: *analysis_settings_hardest_kt_embed_R02
        event_activity: "central"
        chunk_size: 4000
        background_subtraction:
          r_max: 0.1
        det_level_artificial_tracking_efficiency: 0.98
    63:
      # Extract **just** the hybrid level as data, such that we don't require matching,
      # giving us a full sample with combinatorics.
      metadata:
        # NOTE: We decide to directly define what is usually in the base metadata here,
        #       so we don't need the usual reference to it.
        # Map from key -> value of how prefixes should be renamed after embedding
        post_embedding_rename_levels:
          hybrid_level: "data"
        dataset: *LHC20g4_pythia
        # We only use a fraction for expediency. We shouldn't need the full stats...
        sample_dataset_fraction: 0.2
        production_number: 63
        label: "embed_pythia_central"
      settings:
        # These PbPb settings are what defines that we'll only handle the data, as opposed
        # to the usual embedding. The renaming done above is necessary for this to work
        # (but the metadata renaming is not sufficient - it also needs these PbPb settings).
        <<: *analysis_settings_hardest_kt_PbPb_R02
        output_settings:
          <<: *reclustered_substructure_output_settings
        event_activity: "central"
        chunk_size: 4000
        background_subtraction:
          r_max: 0.1
        det_level_artificial_tracking_efficiency: 0.98
        generator_analysis_arguments:
          # We don't need to select charged particles since it's an ALICE production.
          # All good
          select_charged_particles: false
